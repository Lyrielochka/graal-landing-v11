<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Пепел и Память — интерактивная карта и архив</title>
<meta name="description" content="Интерактивная память о геноциде на территории Беларуси: карта исчезнувших деревень, фотоархив, свидетельства, видео, документы. Акцент: вся страна и район агрогородка Урицкое."/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Manrope:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Leaflet map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<style>
:root{
  --bg:#0a0d11;
  --bg2:#10141a;
  --fg:#e9edf1;
  --muted:#a9b3be;
  --accent:#c9a769;
  --danger:#e05d5d;
  --line:#20252e;
  --shadow:0 20px 60px rgba(0,0,0,.5);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Manrope,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--fg);
  background:#0a0d11;
  line-height:1.65;
  overflow-x:hidden;
}

/* ===== Animated Background Layers ===== */
.bg-wrap{
  position:fixed; inset:0; z-index:-1; overflow:hidden; pointer-events:none;
}
#smokeCanvas{
  position:absolute; inset:0;
  width:100%; height:100%;
  background:radial-gradient(1200px 600px at 10% -10%, #151a22 0%, transparent 60%),
             radial-gradient(1000px 600px at 100% 0%, #131821 0%, transparent 60%),
             linear-gradient(#0a0d11,#0a0d11);
}
.embers{
  position:absolute; inset:0;
}
.ember{
  position:absolute; width:2px; height:2px; border-radius:50%;
  background:rgba(255,160,90,.9);
  box-shadow:0 0 8px rgba(255,160,90,.8), 0 0 18px rgba(255,120,60,.35);
  opacity:.0; transform:translateY(0) scale(.9);
  animation: floatUp linear forwards;
}
@keyframes floatUp{
  0%{opacity:0; transform:translateY(0) scale(.8)}
  10%{opacity:.7}
  90%{opacity:.5}
  100%{opacity:0; transform:translateY(-120vh) scale(1.1)}
}
.vignette{
  position:absolute; inset:0; pointer-events:none;
  background:
    radial-gradient(1200px 800px at 50% -20%, rgba(255,180,100,.04), transparent 60%),
    radial-gradient(1600px 1000px at 50% 120%, rgba(255,180,100,.03), transparent 60%),
    radial-gradient(circle at 50% 50%, transparent 30%, rgba(0,0,0,.55) 100%);
}
.noise{
  position:absolute; inset:-50% -50% -50% -50%; opacity:.05; mix-blend-mode:soft-light;
  background-image:url('data:image/svg+xml;utf8,\
  <svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140">\
  <filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="2" stitchTiles="stitch"/></filter>\
  <rect width="100%" height="100%" filter="url(%23n)" opacity="0.35"/></svg>');
  animation: drift 90s linear infinite;
}
@keyframes drift{from{transform:translate3d(0,0,0)} to{transform:translate3d(25%,25%,0)}}

@media (prefers-reduced-motion: reduce){
  .ember{animation:none; opacity:.05}
  .noise{animation:none}
}

/* ===== Frame & Ornaments ===== */
.container{max-width:1200px; margin:0 auto; padding:0 16px}
.hr{
  height:1px; background:linear-gradient(90deg, transparent, #3a3f49, transparent);
  margin:28px 0;
}
.hr.gold{
  height:2px; border-radius:2px;
  background:linear-gradient(90deg, transparent, rgba(201,167,105,.65), transparent);
}

/* ===== Header / Nav ===== */
header{
  position:sticky; top:0; z-index:10;
  background:rgba(10,13,17,.72);
  border-bottom:1px solid var(--line);
  backdrop-filter:saturate(120%) blur(10px);
}
.nav{
  display:flex; align-items:center; justify-content:space-between; gap:16px;
  padding:10px 0;
}
.brand{display:flex; align-items:center; gap:12px}
.logo{
  width:38px; height:38px; border-radius:50%;
  background:conic-gradient(from 200deg, #2e333c, #0f1217);
  box-shadow:inset 0 0 0 1px #2f343d, inset 0 0 18px rgba(201,167,105,.25);
}
.brand h1{
  margin:0; font-family:"Cormorant Garamond",serif;
  font-weight:600; letter-spacing:.4px; font-size:19px;
}
nav ul{display:flex; gap:14px; list-style:none; margin:0; padding:0; flex-wrap:wrap}
nav a{
  display:block; padding:8px 12px; border-radius:12px;
  color:var(--fg); text-decoration:none; border:1px solid transparent;
  transition:border .2s, background .2s, transform .2s;
}
nav a:hover{border-color:#343a45; background:#131922; transform:translateY(-1px)}

/* ===== Hero ===== */
.hero{
  position:relative; overflow:hidden;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,200,120,.03), rgba(255,200,120,0) 40%), linear-gradient(180deg, #0b0e13, #0b0e13);
}
.hero-inner{
  display:grid; grid-template-columns:1.1fr .9fr; gap:32px;
  padding:72px 0 52px;
}
@media (max-width:980px){ .hero-inner{grid-template-columns:1fr; padding:56px 0 36px} }

.hero h2{
  font-family:"Cormorant Garamond",serif;
  font-weight:600;
  font-size: clamp(30px, 4.5vw, 56px);
  line-height:1.08; margin:0 0 14px;
  text-shadow:0 1px 0 #000;
}
.hero p{color:var(--muted); margin:0 0 18px; max-width:65ch}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  border:1px solid #313744; padding:6px 10px; border-radius:999px;
  font-size:13px; color:#cbd5df; background:#0f1217;
}
.badge .dot{width:8px; height:8px; border-radius:50%; background:var(--danger); box-shadow:0 0 16px rgba(224,93,93,.6)}
.cta{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px}
.btn{
  padding:12px 16px; border-radius:12px; border:1px solid #313744;
  color:var(--fg); text-decoration:none; display:inline-flex; align-items:center; gap:10px;
  background:#141922; box-shadow:var(--shadow); transition:transform .15s ease, background .2s, border .2s;
}
.btn:hover{background:#151b25; border-color:#3a404b; transform:translateY(-1px)}
.btn.alt{background:transparent}
.small{font-size:12px; color:#93a0ad}

/* ===== Counter ===== */
.counter{
  background:linear-gradient(180deg,#0d1117,#0c0f14); border:1px solid #272e39; border-radius:16px; padding:18px;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
}
.counter-label{color:#b3bdc9; font-size:13px; letter-spacing:.4px; text-transform:uppercase}
.counter-value{
  font-family:"Cormorant Garamond",serif;
  font-size: clamp(40px, 7.5vw, 104px);
  letter-spacing:.06em;
  margin:4px 0 8px;
  color:#f3f6f9;
}
.counter-note{color:#9aa6b2; font-size:13px}

/* ===== Section ===== */
.section{padding:46px 0; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#0a0d11,#0b0e13)}
.section h3{
  font-family:"Cormorant Garamond",serif; font-weight:600;
  font-size: clamp(24px, 3.2vw, 34px); margin:0 0 10px;
}
.section p.lead{color:var(--muted); margin:0 0 18px}

/* ===== Map ===== */
#map{height:420px; border-radius:14px; border:1px solid #242a34; box-shadow:var(--shadow); overflow:hidden}
.legend{
  margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; color:#b7c2ce; font-size:13px;
}
.legend span{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid #2b3038; border-radius:10px; background:#11161f}
.legend i{display:inline-block; width:10px; height:10px; border-radius:50%}
.i-vanished{background:#e05d5d}
.i-ruins{background:#d1a85f}
.i-uritskoye{background:#7bb4ff}

/* ===== Gallery ===== */
.gallery{
  display:grid; grid-template-columns:repeat(12,1fr); gap:12px;
}
.card{
  grid-column:span 3; min-height:160px; border:1px solid #242a34; border-radius:14px; overflow:hidden; background:#0e1218;
  position:relative; cursor:pointer; transition:transform .25s ease, filter .25s ease, border .2s;
}
.card:nth-child(4n+1){grid-column:span 6; min-height:240px}
@media (max-width:1100px){ .card{grid-column:span 4} .card:nth-child(4n+1){grid-column:span 8} }
@media (max-width:800px){ .card,.card:nth-child(4n+1){grid-column:span 12} }
.card img{width:100%; height:100%; object-fit:cover; display:block; filter:grayscale(100%) contrast(1.05); opacity:.94; transform:scale(1.02); transition:inherit}
.card:hover{transform:translateY(-2px)}
.card:hover img{filter:grayscale(95%) contrast(1.1); transform:scale(1.04)}
.card .cap{
  position:absolute; left:0; right:0; bottom:0;
  background:linear-gradient(180deg, transparent, rgba(0,0,0,.75));
  padding:12px; font-size:14px; color:#d8e0ea;
}

/* ===== Lightbox ===== */
.lightbox{
  position:fixed; inset:0; background:rgba(7,9,12,.9); display:none; align-items:center; justify-content:center;
  z-index:1000; padding:16px;
}
.lightbox.open{display:flex}
.lightbox img{max-width:min(1200px,90vw); max-height:80vh; border:1px solid #2a313c; border-radius:12px; box-shadow:var(--shadow)}
.lightbox .caption{margin-top:10px; color:#c1ccd7; text-align:center}

/* ===== Videos ===== */
.videos{
  display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;
}
@media (max-width:980px){ .videos{grid-template-columns:1fr} }
.video{
  border:1px solid #242a34; border-radius:14px; overflow:hidden; background:#0e1218; transition:transform .2s;
}
.video:hover{transform:translateY(-2px)}
.video .r16x9{position:relative; width:100%; padding-top:56.25%}
.video iframe{position:absolute; inset:0; width:100%; height:100%; border:0}

/* ===== Downloads ===== */
.downloads{
  display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;
}
@media (max-width:980px){ .downloads{grid-template-columns:1fr} }
.dl{
  border:1px solid #242a34; border-radius:14px; background:#0e1218; padding:14px;
  display:flex; align-items:center; justify-content:space-between; gap:12px; transition:transform .2s;
}
.dl:hover{transform:translateY(-2px)}
.dl .meta{display:flex; flex-direction:column}
.dl .meta small{color:#8e9aa6}

/* ===== Quotes ===== */
.quote{
  border-left:3px solid var(--accent); padding:10px 14px; background:#0e1218; border-radius:10px; border:1px solid #242a34;
}
.quote cite{display:block; color:#9fb0c1; margin-top:8px; font-size:14px}

/* ===== Accessibility toggles ===== */
.toolbar{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
}
.toggle{
  display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid #2b3038; border-radius:10px; background:#10151d; cursor:pointer; user-select:none;
}
.toggle input{accent-color:var(--accent)}

/* ===== Footer ===== */
footer{
  padding:28px 0; border-top:1px solid var(--line); background:#0a0d11; color:#9aa6b2;
}
footer .cols{display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap}
footer a{color:#b9c5d4}

/* ===== Utility ===== */
.reveal{opacity:0; transform:translateY(10px); transition:opacity .6s ease, transform .6s ease}
.reveal.show{opacity:1; transform:none}
.hidden{position:absolute !important; left:-9999px !important}
body.high-contrast{color:#fff; background:#000}
body.high-contrast .card img{filter:grayscale(100%) contrast(1.3)}
body.dyslexia{font-family:Arial, Helvetica, Verdana, sans-serif}
</style>
</head>
<body>

<!-- Background -->
<div class="bg-wrap" aria-hidden="true">
  <canvas id="smokeCanvas"></canvas>
  <div class="embers" id="embers"></div>
  <div class="noise"></div>
  <div class="vignette"></div>
</div>

<header>
  <div class="container nav">
    <div class="brand" aria-label="Название сайта">
      <div class="logo" aria-hidden="true"></div>
      <h1>Пепел и Память</h1>
    </div>
    <nav aria-label="Основная навигация">
      <ul>
        <li><a href="#counter">Счётчик</a></li>
        <li><a href="#map-section">Карта</a></li>
        <li><a href="#photos">Фото</a></li>
        <li><a href="#videos">Видео</a></li>
        <li><a href="#docs">Книги</a></li>
        <li><a href="#voices">Свидетельства</a></li>
        <li><a href="#about">О проекте</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container hero-inner">
    <div class="reveal">
      <span class="badge" aria-label="Тема сайта"><span class="dot" aria-hidden="true"></span> Памяти жертв геноцида в Беларуси</span>
      <h2>«Пепел и Память». Беларусь 1941–1944. <br>Район агрогородка Урицкое — часть общей трагедии.</h2>
      <p>Это тихое пространство памяти. Здесь — карта исчезнувших деревень, фотографии раскопок, свидетельства, видео и документы. Все данные требуют верификации и ссылок на источники.</p>
      <div class="cta">
        <a class="btn" href="#map-section">Перейти к карте</a>
        <a class="btn alt" href="#docs">Скачать книги и материалы</a>
      </div>
      <p class="small">Адаптивная вёрстка. Числа и точки на карте — <strong>заполняемые</strong>; пожалуйста, работайте с историками/архивистами.</p>
    </div>

    <aside class="counter reveal" id="counter" aria-live="polite">
      <div class="counter-label">Погибшие мирные жители и узники, по подтверждённым данным</div>
      <!-- целевое значение задайте в data-target -->
      <div class="counter-value" id="bigCounter" data-target="0000000">0</div>
      <div class="counter-note">Цифра обновляется редакторами проекта по мере верификации источников.</div>
    </aside>
  </div>
  <div class="container"><div class="hr gold" aria-hidden="true"></div></div>
</section>

<section id="map-section" class="section">
  <div class="container">
    <h3 class="reveal">Интерактивная карта исчезнувших деревень</h3>
    <p class="lead reveal">Замените заглушки на реальные координаты, годы трагедии, ссылки на источники. Цвета: <strong>красный</strong> — исчезнувшие деревни, <strong>золото</strong> — места массовых расстрелов/руин, <strong>синий</strong> — Урицкое и ближайшие локации.</p>
    <div id="map" class="reveal" role="application" aria-label="Карта памяти"></div>
    <div class="legend reveal" aria-hidden="true">
      <span><i class="i-vanished"></i> исчезнувшие деревни</span>
      <span><i class="i-ruins"></i> места расстрелов/руин</span>
      <span><i class="i-uritskoye"></i> Урицкое и окрестности</span>
    </div>
  </div>
</section>

<section id="photos" class="section">
  <div class="container">
    <h3 class="reveal">Фотографии с раскопок и экспедиций</h3>
    <p class="lead reveal">Загрузите изображения в папку <code>/images/</code> и замените пути/подписи. Указывайте дату, место и источник.</p>

    <div class="gallery" id="gallery">
      <figure class="card reveal" data-src="images/excavation_01.jpg" data-caption="Раскоп, сектор А. Подпись, дата, источник.">
        <img src="images/excavation_01.jpg" alt="Раскопки, сектор А"/>
        <figcaption class="cap">Раскопки, сектор А</figcaption>
      </figure>

      <figure class="card reveal" data-src="images/excavation_02.jpg" data-caption="Фрагменты печных кирпичей. Подпись, дата, источник.">
        <img src="images/excavation_02.jpg" alt="Фрагменты печных кирпичей"/>
        <figcaption class="cap">Фрагменты печных кирпичей</figcaption>
      </figure>

      <figure class="card reveal" data-src="images/uritskoye_forest.jpg" data-caption="Лесной массив близ Урицкого. Подпись, дата, источник.">
        <img src="images/uritskoye_forest.jpg" alt="Лесной массив близ Урицкого"/>
        <figcaption class="cap">Лес близ Урицкого</figcaption>
      </figure>

      <figure class="card reveal" data-src="images/memorial_marker.jpg" data-caption="Памятный знак. Подпись, дата, источник.">
        <img src="images/memorial_marker.jpg" alt="Памятный знак"/>
        <figcaption class="cap">Памятный знак</figcaption>
      </figure>
    </div>
  </div>
</section>

<section id="videos" class="section">
  <div class="container">
    <h3 class="reveal">Видео и хроника</h3>
    <p class="lead reveal">Для вставки YouTube замените <code>VIDEO_ID</code> на реальный идентификатор.</p>
    <div class="videos">
      <div class="video reveal">
        <div class="r16x9"><iframe src="https://www.youtube.com/embed/VIDEO_ID" title="Документальный фильм — пример" allowfullscreen loading="lazy"></iframe></div>
      </div>
      <div class="video reveal">
        <div class="r16x9"><iframe src="https://www.youtube.com/embed/VIDEO_ID" title="Интервью со свидетелем — пример" allowfullscreen loading="lazy"></iframe></div>
      </div>
      <div class="video reveal">
        <div class="r16x9"><iframe src="https://www.youtube.com/embed/VIDEO_ID" title="Лекция историка — пример" allowfullscreen loading="lazy"></iframe></div>
      </div>
    </div>
  </div>
</section>

<section id="docs" class="section">
  <div class="container">
    <h3 class="reveal">Книги и документы</h3>
    <p class="lead reveal">Файлы положите в <code>/downloads/</code>. Указывайте правообладателя и источник.</p>
    <div class="downloads">
      <div class="dl reveal">
        <div class="meta">
          <strong>Учебное пособие: История трагедии (PDF)</strong>
          <small>12.4&nbsp;MB • редакция от 2025-09-01</small>
        </div>
        <a class="btn" href="downloads/manual_genocide_history.pdf" download>Скачать</a>
      </div>
      <div class="dl reveal">
        <div class="meta">
          <strong>Сборник свидетельств по району Урицкое (PDF)</strong>
          <small>8.2&nbsp;MB • версия 1.0</small>
        </div>
        <a class="btn" href="downloads/uritskoye_testimonies.pdf" download>Скачать</a>
      </div>
    </div>
    <div class="hr gold" aria-hidden="true"></div>
  </div>
</section>

<section id="voices" class="section">
  <div class="container">
    <h3 class="reveal">Свидетельства и память</h3>
    <div class="quote reveal">
      «Тут было тихо, только ветер в соснах. Мы знали, что под этой землёй — люди. Мы пришли назвать их по именам.»
      <cite>— экспедиционные заметки, год/источник</cite>
    </div>
    <p class="small" style="margin-top:10px">Публикуйте только проверенные цитаты. Соблюдайте законодательство о персональных данных.</p>
  </div>
</section>

<section id="about" class="section">
  <div class="container">
    <h3 class="reveal">О проекте</h3>
    <p class="lead reveal">Проект создаётся педагогами, учащимися и краеведами. Цель — бережно собрать и показать фактические материалы о геноциде на территории Беларуси, с особым вниманием к нашему району.</p>
    <div class="toolbar reveal" role="group" aria-label="Настройки доступности">
      <label class="toggle"><input type="checkbox" id="hcToggle"/> Высокий контраст</label>
      <label class="toggle"><input type="checkbox" id="dxToggle"/> Упростить шрифты</label>
      <a class="btn alt" href="#contribute">Как прислать материалы</a>
    </div>
    <p id="contribute" class="small" style="margin-top:10px">Материалы присылайте на <a href="mailto:memory@example.org">memory@example.org</a> с указанием источника, даты, автора и разрешений на публикацию.</p>
  </div>
</section>

<footer>
  <div class="container cols">
    <div>
      <strong>Пепел и Память</strong><br/>
      Образовательный некоммерческий проект. Все права на материалы принадлежат их авторам и правообладателям.
    </div>
    <div>
      <a href="#about">О проекте</a> •
      <a href="#docs">Документы</a> •
      <a href="#map-section">Карта</a>
      <div class="small">© 2025</div>
    </div>
  </div>
</footer>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" aria-modal="true" role="dialog" aria-label="Просмотр изображения">
  <div>
    <img src="" alt="" id="lightboxImg"/>
    <div class="caption" id="lightboxCap"></div>
  </div>
</div>

<script>
/* ===== Counter ===== */
(function(){
  const el = document.getElementById('bigCounter');
  const targetRaw = (el.getAttribute('data-target') || '0').replace(/\D/g,'');
  const target = parseInt(targetRaw, 10) || 0;
  function format(n){ return n.toLocaleString('ru-RU'); }
  function animateCount(duration=2500){
    const start = 0, t0 = performance.now();
    function step(now){
      const p = Math.min(1, (now - t0) / duration);
      const eased = 1 - Math.pow(1-p, 3);
      const val = Math.floor(start + (target - start) * eased);
      el.textContent = format(val);
      if(p < 1) requestAnimationFrame(step);
    }
    el.textContent = format(0);
    if(target>0) requestAnimationFrame(step);
  }
  animateCount();
})();

/* ===== Leaflet Map ===== */
let map;
let layers = { vanished: null, ruins: null, uritskoye: null };
function initMap(){
  map = L.map('map', {scrollWheelZoom:false, attributionControl:true})
          .setView([52.4, 31.1], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'&copy; OpenStreetMap'}).addTo(map);

  const red = { radius:7, color:'#e05d5d', fillColor:'#e05d5d', fillOpacity:0.9, weight:1 };
  const gold = { radius:7, color:'#c9a769', fillColor:'#c9a769', fillOpacity:0.9, weight:1 };
  const blue = { radius:7, color:'#7bb4ff', fillColor:'#7bb4ff', fillOpacity:0.9, weight:1 };

  // TODO: заменить на валидированные данные
  const vanishedVillages = [
    { name:'Деревня (пример)', year:'1943', victims:'—', coords:[52.50, 31.00], source:'Ссылка/архив' },
    { name:'Деревня (пример 2)', year:'1942', victims:'—', coords:[52.30, 31.40], source:'Ссылка/архив' },
  ];
  const ruinsSites = [
    { name:'Место расстрела (пример)', year:'1943', victims:'—', coords:[52.60, 31.20], source:'Ссылка/архив' },
  ];
  const uritskoyeArea = [
    { name:'Агрогородок Урицкое', year:'—', victims:'—', coords:[52.310, 31.117], source:'Поселение' }
  ];

  layers.vanished = L.layerGroup(vanishedVillages.map(p=>{
    return L.circleMarker(p.coords, red).bindPopup(
      `<strong>${p.name}</strong><br/>Год: ${p.year}<br/>Погибшие: ${p.victims}<br/><a href="#" onclick="return false">Источник</a>`
    );
  })).addTo(map);
  layers.ruins = L.layerGroup(ruinsSites.map(p=>{
    return L.circleMarker(p.coords, gold).bindPopup(
      `<strong>${p.name}</strong><br/>Год: ${p.year}<br/>Погибшие: ${p.victims}<br/><a href="#" onclick="return false">Источник</a>`
    );
  })).addTo(map);
  layers.uritskoye = L.layerGroup(uritskoyeArea.map(p=>{
    return L.circleMarker(p.coords, blue).bindPopup(
      `<strong>${p.name}</strong><br/>Инфо: ${p.source}`
    );
  })).addTo(map);

  L.control.layers(null, {
    "Исчезнувшие деревни": layers.vanished,
    "Места расстрелов/руин": layers.ruins,
    "Урицкое и окрестности": layers.uritskoye
  }, { position:'topright', collapsed:true }).addTo(map);

  const mapEl = document.getElementById('map');
  const setH = ()=>{ mapEl.style.height = (window.innerWidth < 600 ? 300 : 420) + 'px'; map.invalidateSize();};
  setH(); window.addEventListener('resize', setH);
}
document.addEventListener('DOMContentLoaded', initMap);

/* ===== Gallery Lightbox ===== */
(function(){
  const lb = document.getElementById('lightbox');
  const lbImg = document.getElementById('lightboxImg');
  const lbCap = document.getElementById('lightboxCap');
  document.getElementById('gallery')?.addEventListener('click', e=>{
    const fig = e.target.closest('.card'); if(!fig) return;
    lbImg.src = fig.dataset.src || fig.querySelector('img')?.src || '';
    lbImg.alt = fig.querySelector('img')?.alt || '';
    lbCap.textContent = fig.dataset.caption || '';
    lb.classList.add('open');
  });
  lb.addEventListener('click', ()=> lb.classList.remove('open'));
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') lb.classList.remove('open'); });
})();

/* ===== Accessibility toggles ===== */
document.getElementById('hcToggle')?.addEventListener('change', e=>{
  document.body.classList.toggle('high-contrast', e.target.checked);
});
document.getElementById('dxToggle')?.addEventListener('change', e=>{
  document.body.classList.toggle('dyslexia', e.target.checked);
});

/* ===== Reveal-on-scroll ===== */
(function(){
  const els = document.querySelectorAll('.reveal');
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(ent=>{
      if(ent.isIntersecting){ ent.target.classList.add('show'); io.unobserve(ent.target); }
    });
  }, { threshold: .15 });
  els.forEach(el=> io.observe(el));
})();

/* ===== Animated Background (Smoke + Embers) ===== */
(function(){
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const canvas = document.getElementById('smokeCanvas');
  const ctx = canvas.getContext('2d');
  let w, h, t = 0, raf;

  function setSize(){
    w = canvas.width = window.innerWidth * devicePixelRatio;
    h = canvas.height = window.innerHeight * devicePixelRatio;
    ctx.scale(devicePixelRatio, devicePixelRatio);
  }
  setSize(); window.addEventListener('resize', setSize);

  // Soft smoky blobs via layered radial gradients + noise shift
  function draw(){
    t += 0.0025;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // base fill
    ctx.fillStyle = '#0a0d11';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const blobs = [
      { x:.2 + Math.sin(t*0.6)*.02, y:.15 + Math.cos(t*0.4)*.02, r: 380, c:'rgba(255,190,120,0.04)' },
      { x:.8 + Math.cos(t*0.5)*.02, y:.12 + Math.sin(t*0.3)*.02, r: 320, c:'rgba(255,180,110,0.035)' },
      { x:.5 + Math.sin(t*0.3)*.03, y:.95, r: 520, c:'rgba(255,170,100,0.035)' }
    ];
    blobs.forEach(b=>{
      const gx = b.x * window.innerWidth, gy = b.y * window.innerHeight;
      const grad = ctx.createRadialGradient(gx, gy, 0, gx, gy, b.r);
      grad.addColorStop(0, b.c);
      grad.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(gx, gy, b.r, 0, Math.PI*2); ctx.fill();
    });

    raf = requestAnimationFrame(draw);
  }

  if(!prefersReduced){ draw(); }

  // Embers (floating sparks)
  const embers = document.getElementById('embers');
  const COUNT = Math.min(60, Math.floor(window.innerWidth/20));
  function spawnEmber(){
    const e = document.createElement('div');
    e.className = 'ember';
    const size = Math.random()*2 + 1;
    e.style.width = e.style.height = size + 'px';
    e.style.left = (Math.random()*100) + 'vw';
    e.style.bottom = (-10 - Math.random()*20) + 'px';
    const dur = 8000 + Math.random()*8000;
    e.style.animationDuration = dur + 'ms';
    e.style.animationDelay = (-Math.random()*dur) + 'ms';
    // slight horizontal drift & flicker
    const drift = (Math.random()*2-1) * (12 + Math.random()*8);
    e.animate([
      { transform:`translate(0,0) scale(.9)` },
      { transform:`translate(${drift}px,-20vh) scale(1)` },
      { transform:`translate(${drift*1.6}px,-60vh) scale(1.05)` },
      { transform:`translate(${drift*2.2}px,-120vh) scale(1.1)` },
    ], { duration: dur, iterations: Infinity, easing: 'linear' });
    embers.appendChild(e);
    // cleanup occasionally
    setTimeout(()=>{ if(embers.childElementCount > COUNT*2){ embers.removeChild(embers.firstChild); } }, dur*2);
  }
  if(!prefersReduced){
    for(let i=0;i<COUNT;i++) spawnEmber();
    setInterval(spawnEmber, 500);
  }

  // Pause canvas when tab hidden
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ cancelAnimationFrame(raf); }
    else if(!prefersReduced){ draw(); }
  });
})();
</script>
</body>
</html>
